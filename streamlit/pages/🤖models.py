import streamlit as st
import logging
from util.logging_handler import configure_logger
import pandas as pd
import plotly.graph_objects as go
import requests

st.set_page_config(page_title="Models", page_icon="ü§ñ")

logger = configure_logger(__name__, logging.DEBUG)

st.markdown("# Models")
st.sidebar.header("Models")
st.write(
    """–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥–µ–ª—è—Ö"""
)


def fetch_models():
    response = requests.get(st.session_state.backend_url + "/models")
    data = response.json()
    return data

data = [
    {
        "models": [
            {
                "id": "linear_123",
                "description": "Linear regression model",
                "type": "social",
                "hyperparameters": {"learning_rate": 0.01, "epochs": 50},
                "learning_curve": [0.9, 0.7, 0.5, 0.3, 0.2],
            },
            {
                "id": "linear_2",
                "type": "news",
                "description": "Linear regression model 2",
                "hyperparameters": {"learning_rate": 0.1, "epochs": 100},
                "learning_curve": [1.0, 0.8, 0.6, 0.4, 0.25, 0.1, 0.05],
            },
        ]
    }
]

models = data[0]['models']
models_df = pd.DataFrame([
    {
        "ID": model["id"],
        "Type": model["type"],
        "Hyperparameters": str(model["hyperparameters"]),
        "Has Loss Curve": bool(model["learning_curve"])
    }
    for model in models
])

st.subheader("–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π")
st.dataframe(models_df)

model_ids = [model["id"] for model in models]
selected_model_id = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:", model_ids)

selected_model = next(model for model in models if model["id"] == selected_model_id)
st.write("### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏")
st.json(selected_model)

if selected_model["learning_curve"]:
    st.write("### –ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è")

    fig = go.Figure()
    fig.add_trace(
        go.Scatter(
            y=selected_model["learning_curve"],
            mode='lines+markers',
            name=f"–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è ({selected_model_id})"
        )
    )
    fig.update_layout(
        title=f"–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ {selected_model_id}",
        xaxis_title="–≠–ø–æ—Ö–∞",
        yaxis_title="–§—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å",
        template="plotly_white"
    )
    st.plotly_chart(fig)

else:
    st.write("–î–ª—è –¥–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—Ä–∏–≤–æ–π –æ–±—É—á–µ–Ω–∏—è")

logger.debug("Models page loaded")
